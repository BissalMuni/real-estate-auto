name: Update Real Estate Data

on:
  push:
    paths: 
      - 'data/*.csv'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (í•µì‹¬ í•´ê²°ì±…)
concurrency:
  group: real-estate-update
  cancel-in-progress: false

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y --force
        npm install papaparse
        
    - name: Process CSV files
      run: |
        if [ ! -f "scripts/process-csv.js" ]; then
          echo "Creating process-csv.js..."
          mkdir -p scripts
          cat > scripts/process-csv.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const Papa = require('papaparse');
        
        // CSV íŒŒì¼ë“¤ ì°¾ê¸°
        const dataDir = './data';
        let allData = [];
        let fileStats = [];
        
        if (fs.existsSync(dataDir)) {
          const csvFiles = fs.readdirSync(dataDir)
            .filter(file => file.endsWith('.csv'))
            .sort();
          
          console.log(`ë°œê²¬ëœ CSV íŒŒì¼: ${csvFiles.length}ê°œ`);
          
          csvFiles.forEach(file => {
            console.log(`ì²˜ë¦¬ ì¤‘: ${file}`);
            const filePath = path.join(dataDir, file);
            const csvContent = fs.readFileSync(filePath, 'utf8');
            
            const parsed = Papa.parse(csvContent, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: true
            });
            
            const dataWithSource = parsed.data.map(row => ({
              ...row,
              ì†ŒìŠ¤íŒŒì¼: file,
              ì²˜ë¦¬ì¼ì‹œ: new Date().toLocaleString('ko-KR')
            }));
            
            allData = allData.concat(dataWithSource);
            fileStats.push({
              íŒŒì¼ëª…: file,
              í–‰ìˆ˜: parsed.data.length,
              ì²˜ë¦¬ì‹œê°„: new Date().toLocaleString('ko-KR')
            });
          });
        }
        
        // HTML ìƒì„±
        const totalCount = allData.length;
        const avgPrice = totalCount > 0 ? 
          allData.reduce((sum, row) => {
            const price = parseFloat(row['ë„¤ì´ë²„_ë§¤ë§¤ê°€_ìˆ«ì']) || 0;
            return sum + price;
          }, 0) / totalCount : 0;
        
        const uniqueLocations = new Set(allData.map(row => 
          row['ë„¤ì´ë²„_ì‹œë„'] && row['ë„¤ì´ë²„_ì‹œêµ°êµ¬'] ? 
          `${row['ë„¤ì´ë²„_ì‹œë„']} ${row['ë„¤ì´ë²„_ì‹œêµ°êµ¬']}` : 'ì•Œ ìˆ˜ ì—†ìŒ'
        )).size;
        
        let dataTableHTML = '';
        if (totalCount > 0) {
          const headers = Object.keys(allData[0]);
          dataTableHTML = `
            <h2>ğŸ“Š ì²˜ë¦¬ëœ ë°ì´í„°</h2>
            <div style="overflow-x: auto; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8f9fa; position: sticky; top: 0;">
                  <tr>
                    ${headers.map(header => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px;">${header}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${allData.slice(0, 50).map(row => `
                    <tr>
                      ${headers.map(header => {
                        let value = row[header] || '';
                        if (header.includes('ë§¤ë§¤ê°€') && typeof value === 'number') {
                          value = `<span style="color: #e74c3c; font-weight: bold;">${value.toLocaleString()}</span>`;
                        }
                        return `<td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${value}</td>`;
                      }).join('')}
                    </tr>
                  `).join('')}
                  ${allData.length > 50 ? `<tr><td colspan="${headers.length}" style="text-align: center; padding: 10px; font-style: italic;">... ì™¸ ${allData.length - 50}ê°œ í–‰</td></tr>` : ''}
                </tbody>
              </table>
            </div>
          `;
        }
        
        const html = `<!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ë¶€ë™ì‚° ë°ì´í„° ëŒ€ì‹œë³´ë“œ</title>
            <style>
                body { 
                    font-family: 'Segoe UI', Arial, sans-serif; 
                    margin: 0;
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }
                .container {
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 1200px;
                    margin: 0 auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                }
                h1 { 
                    color: #667eea; 
                    text-align: center;
                    margin-bottom: 30px;
                    font-size: 2.5em;
                }
                h2 {
                    color: #764ba2;
                    margin: 30px 0 15px 0;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin: 30px 0;
                }
                .stat-card {
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    text-align: center;
                }
                .stat-card h3 {
                    font-size: 2em;
                    margin-bottom: 10px;
                }
                .update-info {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 20px 0;
                    text-align: center;
                }
                .file-info {
                    background: #e9ecef;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                table { font-size: 12px; }
                @media (max-width: 768px) {
                    .container { padding: 15px; margin: 10px; }
                    h1 { font-size: 2em; }
                    .stats-grid { grid-template-columns: 1fr; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ  ë¶€ë™ì‚° ë°ì´í„° ëŒ€ì‹œë³´ë“œ</h1>
                
                <div class="update-info">
                    <strong>ğŸ• ìµœì¢… ì—…ë°ì´íŠ¸:</strong> ${new Date().toLocaleString('ko-KR')}
                    <br><strong>ğŸ¤– ìë™í™” ì‹œìŠ¤í…œ:</strong> ì •ìƒ ì‘ë™ ì¤‘
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${totalCount.toLocaleString()}</h3>
                        <p>ì´ ë§¤ë¬¼ ìˆ˜</p>
                    </div>
                    <div class="stat-card">
                        <h3>${Math.round(avgPrice).toLocaleString()}</h3>
                        <p>í‰ê·  ë§¤ë§¤ê°€ (ë§Œì›)</p>
                    </div>
                    <div class="stat-card">
                        <h3>${fileStats.length}</h3>
                        <p>ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜</p>
                    </div>
                    <div class="stat-card">
                        <h3>${uniqueLocations}</h3>
                        <p>ê³ ìœ  ì§€ì—­ ìˆ˜</p>
                    </div>
                </div>
                
                ${fileStats.length > 0 ? `
                <h2>ğŸ“ íŒŒì¼ ì²˜ë¦¬ í˜„í™©</h2>
                <div class="file-info">
                    ${fileStats.map(stat => 
                      `<div><strong>${stat.íŒŒì¼ëª…}:</strong> ${stat.í–‰ìˆ˜}ê°œ í–‰ (${stat.ì²˜ë¦¬ì‹œê°„})</div>`
                    ).join('')}
                </div>
                ` : ''}
                
                ${dataTableHTML}
                
                <div style="text-align: center; margin-top: 40px; padding: 20px; color: #6c757d; border-top: 1px solid #dee2e6;">
                    <p>ğŸš€ GitHub Actions & Netlify ìë™ ë°°í¬ ì‹œìŠ¤í…œ</p>
                    <p>CSV íŒŒì¼ì„ data/ í´ë”ì— ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </body>
        </html>`;
        
        fs.writeFileSync('./index.html', html, 'utf8');
        console.log(`HTML íŒŒì¼ ìƒì„± ì™„ë£Œ (ì´ ${totalCount}ê°œ í–‰ ì²˜ë¦¬)`);
        EOF
        fi
        node scripts/process-csv.js
        
    - name: Sync with remote and commit
      run: |
        # Git ì„¤ì •
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ì›ê²© ì €ì¥ì†Œì™€ ë™ê¸°í™”
        echo "ì›ê²© ì €ì¥ì†Œ ë™ê¸°í™” ì¤‘..."
        git fetch origin main
        git reset --hard origin/main
        
        # ë‹¤ì‹œ CSV ì²˜ë¦¬ (ë™ê¸°í™” í›„ ìµœì‹  ë°ì´í„°ë¡œ)
        node scripts/process-csv.js
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        git add index.html
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
        else
          echo "ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
          git commit -m "Auto-update: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ì•ˆì „í•œ í‘¸ì‹œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          for i in {1..3}; do
            echo "í‘¸ì‹œ ì‹œë„ ${i}/3..."
            if git push origin main; then
              echo "í‘¸ì‹œ ì„±ê³µ!"
              break
            else
              echo "í‘¸ì‹œ ì‹¤íŒ¨, ì¬ë™ê¸°í™” í›„ ì¬ì‹œë„..."
              git fetch origin main
              git rebase origin/main
              sleep 2
            fi
            
            if [ $i -eq 3 ]; then
              echo "ìµœì¢… í‘¸ì‹œ ì‹œë„ ì‹¤íŒ¨, ê°•ì œ í‘¸ì‹œ ì‚¬ìš©"
              git push origin main --force-with-lease
            fi
          done
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
